# –ö–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ –∑ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ - –ß–∞—Å—Ç–∏–Ω–∞ 2: Batch Data Lake

## –ö—Ä–∏—Ç–µ—Ä—ñ—ó –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ç–∞ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è

### ‚úÖ –ö–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ç–∞ –Ω–∞–¥–∞—î –±–∞–∂–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
### ‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—é—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–±–æ—Ç–∏ –∫–æ–¥—É (—Å–∫—Ä–∏–Ω—à–æ—Ç–∏ —Ç–∞–±–ª–∏—Ü—å –≤–∏–≤–µ–¥–µ–Ω–Ω—è —Ç–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç –≥—Ä–∞—Ñ—É –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–æ–≥–æ DAG—É)

---

## –Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:

### 1. **–õ–æ–∫–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ pipeline:**
```bash
python batch_processing/test_pipeline_locally.py
```

### 2. **–ó–∞–ø—É—Å–∫ –æ–∫—Ä–µ–º–∏—Ö –µ—Ç–∞–ø—ñ–≤:**
```bash
# –ï—Ç–∞–ø 1: Landing to Bronze
python batch_processing/landing_to_bronze.py

# –ï—Ç–∞–ø 2: Bronze to Silver  
python batch_processing/bronze_to_silver.py

# –ï—Ç–∞–ø 3: Silver to Gold
python batch_processing/silver_to_gold.py
```

### 3. **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:**
```bash
python batch_processing/demo_results.py
```

---

## üéØ **–û–±–æ–≤'—è–∑–∫–æ–≤—ñ —Å–∫—Ä–∏–Ω—à–æ—Ç–∏ –¥–ª—è –∑–¥–∞—á—ñ:**

### **1. –°–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ data lake –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:**
–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–º–∞–Ω–¥–∏ –∞–±–æ –≤–∏–≤–æ–¥—É –ø—Ä–æ–≥—Ä–∞–º–∏:
```
data/
‚îú‚îÄ‚îÄ landing/
‚îÇ   ‚îú‚îÄ‚îÄ athlete_bio.csv
‚îÇ   ‚îî‚îÄ‚îÄ athlete_event_results.csv
‚îú‚îÄ‚îÄ bronze/
‚îÇ   ‚îú‚îÄ‚îÄ athlete_bio/ (parquet files)
‚îÇ   ‚îî‚îÄ‚îÄ athlete_event_results/ (parquet files)  
‚îú‚îÄ‚îÄ silver/
‚îÇ   ‚îú‚îÄ‚îÄ athlete_bio/ (cleaned parquet files)
‚îÇ   ‚îî‚îÄ‚îÄ athlete_event_results/ (cleaned parquet files)
‚îî‚îÄ‚îÄ gold/
    ‚îî‚îÄ‚îÄ avg_stats/ (aggregated parquet files)
```

### **2. –°–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ gold layer:**
–ü–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–≤—ñ–¥ —Ç–∞–±–ª–∏—Ü—ñ –∑ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏:
- –ö–æ–ª–æ–Ω–∫–∏: sport, medal, sex, country_noc, avg_weight, avg_height, timestamp
- –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Å—ñ–≤ –∑ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏–º–∏ —Å–µ—Ä–µ–¥–Ω—ñ–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏

### **3. –°–∫—Ä–∏–Ω—à–æ—Ç –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–æ–≥–æ Airflow DAG:**
- –ì—Ä–∞—Ñ DAG –∑ —Ç—Ä—å–æ–º–∞ –∑–∞–¥–∞—á–∞–º–∏: `landing_to_bronze` ‚Üí `bronze_to_silver` ‚Üí `silver_to_gold`
- –°—Ç–∞—Ç—É—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–∑–µ–ª–µ–Ω—ñ –≥–∞–ª–æ—á–∫–∏)
- –ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

---

## üìã **–ï—Ç–∞–ø–∏ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ –≤ –∫–æ–¥—ñ:**

### **landing_to_bronze.py:**
```python
# –ï—Ç–∞–ø 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∑ FTP-—Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ CSV
# –ï—Ç–∞–ø 2: –ß–∏—Ç–∞–Ω–Ω—è CSV —Ñ–∞–π–ª—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Spark —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ Parquet
```

### **bronze_to_silver.py:**
```python
# –ï—Ç–∞–ø 1: –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑ bronze layer
# –ï—Ç–∞–ø 2: –í–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó —á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç—É –¥–ª—è –≤—Å—ñ—Ö —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –∫–æ–ª–æ–Ω–æ–∫  
# –ï—Ç–∞–ø 3: –î–µ–¥—É–±–ª—ñ–∫–∞—Ü—ñ—è —Ä—è–¥–∫—ñ–≤
```

### **silver_to_gold.py:**
```python
# –ï—Ç–∞–ø 1: –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è –¥–≤–æ—Ö —Ç–∞–±–ª–∏—Ü—å —ñ–∑ silver layer
# –ï—Ç–∞–ø 2: –í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞ –¥–µ—è–∫–∏—Ö –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—å
# –ï—Ç–∞–ø 3: –ó–∞–ø–∏—Å —Ç–∞–±–ª–∏—Ü—ñ –≤ –ø–∞–ø–∫—É gold
```

### **project_solution.py:**
```python
# Task 1: Landing to Bronze - –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ FTP —Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ Parquet
# Task 2: Bronze to Silver - –û—á–∏—â–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É —Ç–∞ –¥–µ–¥—É–±–ª—ñ–∫–∞—Ü—ñ—è  
# Task 3: Silver to Gold - –ê–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
# Define task dependencies - –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ç—Ä—å–æ—Ö —Ñ–∞–π–ª—ñ–≤
```

---

## üîç **–ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:**

### **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ñ–∞–π–ª—ñ–≤:**
```bash
ls -la data/
ls -la data/bronze/
ls -la data/silver/
ls -la data/gold/
```

### **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Parquet —Ñ–∞–π–ª—ñ–≤ —á–µ—Ä–µ–∑ Spark:**
```python
# –ß–∏—Ç–∞–Ω–Ω—è gold layer —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
from pyspark.sql import SparkSession
spark = SparkSession.builder.appName("VerifyResults").getOrCreate()

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ gold layer
df = spark.read.parquet("data/gold/avg_stats")
df.show(20, truncate=False)
df.printSchema()
print(f"Total records: {df.count()}")

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
df.groupBy("sport").count().show()
df.groupBy("medal").count().show()
```

---

## üìä **–û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:**

### **Gold Layer Structure:**
- **sport**: –í–∏–¥ —Å–ø–æ—Ä—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Swimming", "Athletics")
- **medal**: –¢–∏–ø –º–µ–¥–∞–ª—ñ ("Gold", "Silver", "Bronze", "No Medal") 
- **sex**: –°—Ç–∞—Ç—å ("M", "F")
- **country_noc**: –ö–æ–¥ –∫—Ä–∞—ó–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "USA", "GBR")
- **avg_weight**: –°–µ—Ä–µ–¥–Ω—è –≤–∞–≥–∞ (decimal)
- **avg_height**: –°–µ—Ä–µ–¥–Ω—ñ–π –∑—Ä—ñ—Å—Ç (decimal)
- **timestamp**: –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤

### **–ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Å—É:**
```
+----------+------+---+-----------+----------+----------+-------------------+
|sport     |medal |sex|country_noc|avg_weight|avg_height|timestamp          |
+----------+------+---+-----------+----------+----------+-------------------+
|Swimming  |Gold  |M  |USA        |75.50     |180.25    |2024-01-15 10:30:00|
|Athletics |Silver|F  |GBR        |58.75     |165.80    |2024-01-15 10:30:00|
+----------+------+---+-----------+----------+----------+-------------------+
```

---

## üöÄ **–†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –≤ Airflow:**

### **1. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª—ñ–≤:**
```bash
# –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å—ñ —Ñ–∞–π–ª–∏ –≤ Airflow —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
cp -r batch_processing/ /path/to/airflow_sandbox/dags/
```

### **2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ Airflow:**
```
airflow_sandbox/
‚îî‚îÄ‚îÄ dags/
    ‚îî‚îÄ‚îÄ batch_processing/
        ‚îú‚îÄ‚îÄ landing_to_bronze.py
        ‚îú‚îÄ‚îÄ bronze_to_silver.py  
        ‚îú‚îÄ‚îÄ silver_to_gold.py
        ‚îî‚îÄ‚îÄ project_solution.py
```

### **3. –ê–∫—Ç–∏–≤–∞—Ü—ñ—è DAG:**
- DAG ID: `batch_data_lake_pipeline`
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ connection `spark-default` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- –ó–∞–ø—É—Å—Ç—ñ—Ç—å DAG —Ç–∞ –∑—Ä–æ–±—ñ—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –≥—Ä–∞—Ñ—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

---

## ‚úÖ **–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∑–¥–∞—á—ñ –ø—Ä–æ—î–∫—Ç—É:**

- [ ] –ö–æ–¥ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –í—Å—ñ —Ç—Ä–∏ —Ñ–∞–π–ª–∏ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ  
- [ ] –°—Ç–≤–æ—Ä–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ data lake (landing/bronze/silver/gold)
- [ ] –°–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π
- [ ] –°–∫—Ä–∏–Ω—à–æ—Ç gold layer —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
- [ ] Airflow DAG —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —Ç–∞ –ø—Ä–∞—Ü—é—î
- [ ] –°–∫—Ä–∏–Ω—à–æ—Ç –≥—Ä–∞—Ñ—É –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–æ–≥–æ DAG –≤ Airflow
- [ ] –í—Å—ñ –µ—Ç–∞–ø–∏ –ø–æ–∑–Ω–∞—á–µ–Ω—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ –≤ –∫–æ–¥—ñ
- [ ] –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø—Ä–∞—Ü—é—î

---

## üéØ **–ü—ñ–¥—Å—É–º–æ–∫:**

–ü—Ä–æ—î–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ø–æ–≤–Ω–∏–π multi-hop data lake pipeline:
1. **Landing**: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Ä–∏—Ö CSV –¥–∞–Ω–∏—Ö –∑ FTP
2. **Bronze**: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ Parquet —Ñ–æ—Ä–º–∞—Ç  
3. **Silver**: –û—á–∏—â–µ–Ω–Ω—è —Ç–∞ –¥–µ–¥—É–±–ª—ñ–∫–∞—Ü—ñ—è
4. **Gold**: –ê–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏
5. **Orchestration**: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Airflow DAG